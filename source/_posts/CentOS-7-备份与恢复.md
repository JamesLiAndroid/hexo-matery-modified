---
title: CentOS 7 备份与恢复
top: false
cover: false
toc: true
mathjax: true
date: 2021-02-04 14:48:10
password:
summary:
tags:
categories:
---

# CentOS 7 备份与恢复

## 迁移环境介绍

当前使用的是CentOS 7.6版本的服务器镜像，由于出现了机房故障的情况，待恢复后，公司要求进行整个系统进行迁移的工作，并且重新进行域名备份的工作。该服务器承载我司内部即时通讯系统的运行，因此需要整体备份和恢复，并且重新启动服务。

## 系统备份

在原服务器使用tar命令进行打包，使用tar.bz2的格式压缩文件，如下：

```
// 切换管理员
$ sudo su

# cd /

# tar cvpjf backup.tar.bz2 –-exclude=/proc –exclude=/lost+found -–exclude=/backup.tar.bz2 –-exclude=/mnt –exclude=/sys /

```

注意，需要安装依赖bzip2，如下：

```
$ sudo yum install -y bzip2

```

## 系统迁移

### 待迁入机器的前期准备

1. ip设置

设置外网访问以及ip地址，这里要求可以连通外网即可，因为后续还原完成后还要重新修改ip地址。

2. yum安装bzip2

```
$ sudo yum install -y bzip2

```

3. 拷贝进入服务器

```
$ scp ./backup/backup.tar.bz2 root@192.168.164.104:/

```

### 开始还原

```

$ sudo su

# cd /

# tar xvpfj backup.tar.bz2 -C /

```

还原完成后出现以下错误，可以忽略，继续操作。

```
tar: Exiting with failure status due to previous errors

```

### 还原后设置

#### 1. 执行selinux修复 restorecon -Rv /

```
# restorecon -Rv /

```

#### 2. grub2修复引导，/boot目录

```
// 查看硬盘UUID信息
# blkid

/dev/mapper/centos-root: UUID="5fadecf2-0b26-4140-a666-227c360d322d" TYPE="xfs"
/dev/sda2: UUID="BUfxBc-OTHF-rgY4-He23-vjpe-Pt9p-cEWrt0" TYPE="LVM2_member"
/dev/sda1: UUID="2f65063a-f7d7-438e-be8d-e1b86568b225" TYPE="xfs"
/dev/mapper/centos-swap: UUID="86b641f6-236d-4158-8972-f90d2a243b65" TYPE="swap"
/dev/mapper/centos-home: UUID="4ad2ac7f-b244-41a0-9d7b-f8116bc92162" TYPE="xfs"

// 修改启动的硬盘信息
# vim /etc/fstab

// 修改为2f65063a-f7d7-438e-be8d-e1b86568b225信息
#
# /etc/fstab
# Created by anaconda on Wed Aug 21 14:54:48 2019
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos-root /                       xfs     defaults        0 0
UUID=2f65063a-f7d7-438e-be8d-e1b86568b225 /boot                   xfs     defaults        0 0
/dev/mapper/centos-home /home                   xfs     defaults        0 0
/dev/mapper/centos-swap swap                    swap    defaults        0 0

// :wq保存退出

// 
# grub2-install /dev/sda

// 生成grub2启动的配置文件
# grub2-mkconfig -o /boot/grub2/grub.cfg

```

这样引导修复了一半，剩下的需要修改开机默认启动的内核信息。

#### 3. 修改ip地址并测试ssh连接（注意密码的变更）

这里修改时要注意，ip要变更为目标机器的ip地址，而且要注意，恢复以后root密码发生了变化，会被之前备份的机器上的数据进行覆盖。

```

# vim /etc/sysconfig/network-scripts/ifcfg-ens192
// 修改静态地址
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens192
UUID=1b3d8c8c-e041-4193-8f04-7fec654320da
DEVICE=ens192
ONBOOT=yes
IPADDR=192.168.164.104
GATEWAY=192.168.164.254
NETMASK=255.255.255.0
DNS1=202.102.152.3
ZONE=public

// :wq保存退出

// 重启网络服务
# systemctl daemon-reload
# systemctl restart network

```

在开发机测试ssh连接，连接该服务器。

```
ssh root@192.168.164.104  // 密码为原机器的密码

```

#### 4. 重新引导，选择开机启动的内核信息

查看内核启动信息如下：

```bash
cat /boot/grub2/grub.cfg
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub2-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
set pager=1

if [ -s $prefix/grubenv ]; then
  load_env
fi
if [ "${next_entry}" ] ; then
   set default="${next_entry}"
   set next_entry=
   save_env next_entry
   set boot_once=true
else
   set default="${saved_entry}"
fi

if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
else
  menuentry_id_option=""
fi

export menuentry_id_option

if [ "${prev_saved_entry}" ]; then
  set saved_entry="${prev_saved_entry}"
  save_env saved_entry
  set prev_saved_entry=
  save_env prev_saved_entry
  set boot_once=true
fi

function savedefault {
  if [ -z "${boot_once}" ]; then
    saved_entry="${chosen}"
    save_env saved_entry
  fi
}

function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

terminal_output console
if [ x$feature_timeout_style = xy ] ; then
  set timeout_style=menu
  set timeout=5
# Fallback normal timeout code in case the timeout_style feature is
# unavailable.
else
  set timeout=5
fi
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/00_tuned ###
set tuned_params=""
set tuned_initrd=""
### END /etc/grub.d/00_tuned ###

### BEGIN /etc/grub.d/01_users ###
if [ -f ${prefix}/user.cfg ]; then
  source ${prefix}/user.cfg
  if [ -n "${GRUB2_PASSWORD}" ]; then
    set superusers="root"
    export superusers
    password_pbkdf2 root ${GRUB2_PASSWORD}
  fi
fi
### END /etc/grub.d/01_users ###

### BEGIN /etc/grub.d/10_linux ###
menuentry 'CentOS Linux (3.10.0-1127.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-1127.el7.x86_64-advanced-5fadecf2-0b26-4140-a666-227c360d322d' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  2f65063a-f7d7-438e-be8d-e1b86568b225
        else
          search --no-floppy --fs-uuid --set=root 2f65063a-f7d7-438e-be8d-e1b86568b225
        fi
        linux16 /vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-3.10.0-1127.el7.x86_64.img
}
menuentry 'CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-957.27.2.el7.x86_64-advanced-5fadecf2-0b26-4140-a666-227c360d322d' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  2f65063a-f7d7-438e-be8d-e1b86568b225
        else
          search --no-floppy --fs-uuid --set=root 2f65063a-f7d7-438e-be8d-e1b86568b225
        fi
        linux16 /vmlinuz-3.10.0-957.27.2.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-3.10.0-957.27.2.el7.x86_64.img
}
menuentry 'CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-957.el7.x86_64-advanced-5fadecf2-0b26-4140-a666-227c360d322d' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  2f65063a-f7d7-438e-be8d-e1b86568b225
        else
          search --no-floppy --fs-uuid --set=root 2f65063a-f7d7-438e-be8d-e1b86568b225
        fi
        linux16 /vmlinuz-3.10.0-957.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-3.10.0-957.el7.x86_64.img
}
menuentry 'CentOS Linux (0-rescue-8872cb4bf724478ebd933ed18a1cf4a6) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-0-rescue-8872cb4bf724478ebd933ed18a1cf4a6-advanced-5fadecf2-0b26-4140-a666-227c360d322d' {
        load_video
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  2f65063a-f7d7-438e-be8d-e1b86568b225
        else
          search --no-floppy --fs-uuid --set=root 2f65063a-f7d7-438e-be8d-e1b86568b225
        fi
        linux16 /vmlinuz-0-rescue-8872cb4bf724478ebd933ed18a1cf4a6 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-0-rescue-8872cb4bf724478ebd933ed18a1cf4a6.img
}
menuentry 'CentOS Linux (0-rescue-c8c3bfe51b21485288f6ad1fe1cbe3c2) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-0-rescue-c8c3bfe51b21485288f6ad1fe1cbe3c2-advanced-5fadecf2-0b26-4140-a666-227c360d322d' {
        load_video
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  2f65063a-f7d7-438e-be8d-e1b86568b225
        else
          search --no-floppy --fs-uuid --set=root 2f65063a-f7d7-438e-be8d-e1b86568b225
        fi
        linux16 /vmlinuz-0-rescue-c8c3bfe51b21485288f6ad1fe1cbe3c2 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-0-rescue-c8c3bfe51b21485288f6ad1fe1cbe3c2.img
}
if [ "x$default" = 'CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)' ]; then default='Advanced options for CentOS Linux>CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)'; fi;
### END /etc/grub.d/10_linux ###

### BEGIN /etc/grub.d/20_linux_xen ###
### END /etc/grub.d/20_linux_xen ###

### BEGIN /etc/grub.d/20_ppc_terminfo ###
### END /etc/grub.d/20_ppc_terminfo ###

### BEGIN /etc/grub.d/30_os-prober ###
### END /etc/grub.d/30_os-prober ###

### BEGIN /etc/grub.d/40_custom ###
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
### END /etc/grub.d/40_custom ###

### BEGIN /etc/grub.d/41_custom ###
if [ -f  ${config_directory}/custom.cfg ]; then
  source ${config_directory}/custom.cfg
elif [ -z "${config_directory}" -a -f  $prefix/custom.cfg ]; then
  source $prefix/custom.cfg;
fi
### END /etc/grub.d/41_custom ###


```

查找menuentry相关的信息，*CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)* 选择这个信息进行启动，无视其它的启动信息，操作如下：

```

# grub2-set-default 'CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)'

# grub2-mkconfig -o /boot/grub/grub.cfg

```

重启服务器，反复重启进行测试，容易进入grub rescue模式，导致无法启动的情况。在rescue模式下，执行以下命令，让系统回到正常的启动界面：

```
grub rescue> ls

grub rescue> ls (hd0,msdos2)/

grub rescue> set root=(hd0,msdos2)/grub2

grub rescue> set prefix=(hd0,msdos2)/grub2

grub rescue> insmod normal

grub rescue> normal

```

这样执行完成后，就重新进入了前边启动时选择启动选项的页面，可以启动系统。

最后，在登录Linux系统后，重新生成以下grub.cfg文件

```

# cd /boot/grub2/ && mv grub.cfg grub.cfg.bak

# grub2-mkconfig > /boot/grub2/grub.cfg

# grub2-install --boot-directory=/boot /dev/sda

```

生成完毕后，重启，恢复所有正常启动信息。

5. （可选）执行恢复命令之前请再确认一下你所键入的命令是不是你想要的，执行恢复命令可能需要一段不短的时间。 恢复命令结束时，你的工作还没完成，别忘了重新创建那些在备份时被排除在外的目录：

```
mkdir proc
mkdir lost+found
mkdir mnt
mkdir sys
```

## 后续处理

* 问题一：docker run问题

错误信息：

```txt
docker: Error response from daemon: driver failed programming external connectivity on endpoint quizzical_thompson (c2b238f6b003b1f789c989db0d789b4bf3284ff61152ba40dacd0e01bd984653):  (iptables failed: iptables --wait -t filter -A DOCKER ! -i docker0 -o docker0 -p tcp -d 172.17.0.3 --dport 24224 -j ACCEPT: iptables: No chain/target/match by that name.

```

解决方式，注意以管理员方式运行下面的命令：

```
// 1. kill掉docker所有进程
# pkill docker 

// 2.清空nat表的所有链
# iptables -t nat -F

// 3.停止docker默认网桥docker0
# ifconfig docker0 down

// 4.删除docker0网桥
# brctl delbr docker0

// 5. 重启docker服务
# systemctl restart docker

```

如果找不到brctl命令，用下面的方式安装依赖：

```
$ sudo yum install -y bridge-utils

```

## 参考链接

* https://www.cnblogs.com/szy2018/p/13845947.html
* https://www.cnblogs.com/niyeshiyoumo/p/7676097.html
* https://blog.csdn.net/hutao1101175783/article/details/106362340