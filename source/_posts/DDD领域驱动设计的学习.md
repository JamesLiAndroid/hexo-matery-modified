---
title: DDD领域驱动设计的学习
top: false
cover: false
toc: true
mathjax: true
date: 2020-10-03 10:04:54
password:
summary:
tags:
categories:
---

## 解决的实际问题

微服务怎么拆分才算合理，拆分到多小才是微服务？

## 为什么是DDD

微服务的粒度应 该多大呀？微服务到底应该如何拆分和设计呢？微服务的边界应该在哪里？

问题：微服务拆分困境产生的根本原因就是不知道业务或者微服务的边界到底在什么地方

通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型的一致性。

方法论：两层设计、三步划定、两条边界

其核心思想就是将问 题域逐步分解，降低业务理解和系统实现的复杂度。

## 概念

### 核心域、通用域和支撑域

- 领域：这个边界内要解决的业务问题域。领域可以进一步划分为子领域。我们把划分出来的多个子领域称为子域，每个子域对应一个更小的问题域或更小的业务范围。

- 核心域、通用域和支撑域

    - 决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。
    
    - 没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。

    - 还有一种功能子域是必需的，但既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域， 它就是支撑域。

### 限界上下文

- 通用语言：在事件风暴过程中，通过团队交流达成共识的，能够简单、 清晰、准确描述业务涵义和规则的语言就是通用语言。通用语言包含术语和用例场景，并且能够直接反映在代码中。设计过程中我们可以用一些表格， 来记录事件风暴和微服务设计过程中产生的领域对象及其属性。

通用语言定义上下文含义，限界上下文则定义领域边界

DDD 分析和设计过程中的每一个环节都需要保证限界上下文内 术语的统一，在代码模型设计的时侯就要建立领域对象和代码对象的一一映射，从而保证业 务模型和代码模型的一致，实现**业务语言与代码语言的统一**。

- 限界就是领域的边界，而上下文则是 语义环境。

领域边界就是通过限界上下文来定义的。

我们将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。

### 实体和值对象

- 实体：在 DDD 中有这样一类对象，它们拥有唯一标识符，且标识符在历经各种状态变更后仍能保 持一致。对这些对象而言，重要的不是其属性，而是其延续性和标识，对象的延续性和标识 会跨越甚至超出软件的生命周期。我们把这样的对象称为实体。

业务形态、代码形态、运行形态、数据库形态

- 实体和值对象是组成领域模型的基础单元。

DDD 提倡从领域模型设计出发，而不是先设计数据模型。

- 值对象：通过对象属性值来识别的对 象，它将多个相关属性组合为一个概念整体。值对象本质上就是一个集。

- 数据库设计原则：在领域建模时，我们可以将部分对象设计为值对象，保留对象的业务涵义，同时又减少了实体的数量；在数据建模时，我们可以将值对象嵌入实体，减少实体表的数量，简化数据库设计。

是否要设计成值对象，你要看这个对象是否后续还会来回修改，会不会有生命周期。如 果不可修改，并且以后也不会专门针对它进行查询或者统计，你就可以把它设计成值对象。DDD强调领域模型而不是数据模型，所以在设计的时候不建议把数据模型放在很优先的位置，但 是如果你的数据需要经常修改，还是把它设计为实体吧。很多值对象来源于上一个业务流程或者外部第三方的数据，它在上游或者第三方是一个关键实体，甚至是聚合根。但在下游或者其他微服务内它是不可以修改的，要修改也只能从上游或者第三方修改后做整体替换，它只是一个值， 这类领域对象你是可以设计为值对象的。

### 聚合和聚合根

- 聚合：领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性。

聚合包含聚合根和上下文边界。实体和值对象依附于聚合。

跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。

- 聚合根：如果把聚合比作组织，那聚合根就是这个组织的负责人。聚合根也称为根实体，它不仅是实体，还是聚合的管理者。

聚合根本质是实体，拥有自身的业务逻辑；它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑；在聚合之间，它还是聚合对外的接口人，以聚合根ID关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。

- 如何设计：1. 在一致性边界内建模真正的不变条件；2. 设计小聚合；3. 通过唯一标识引用其它聚合；4. 在边界之外使用最终一致性；5. 通过应用层实现跨聚合的服务调用

### 一阶段总结

- 聚合的特点：高内聚、低耦合，它是领域模型中最底层的边界，可以作为拆分微服务的最小 单位，但我不建议你对微服务过度拆分。但在对性能有极致要求的场景中，聚合可以独立作 为一个微服务，以满足版本的高频发布和极致的弹性伸缩能力。

一个微服务可以包含多个聚合，聚合之间的边界是微服务内天然的逻辑边界。有了这个逻辑 边界，在微服务架构演进时就可以以聚合为单位进行拆分和组合了，微服务的架构演进也就 不再是一件难事了。

- 聚合根的特点：聚合根是实体，有实体的特点，具有全局唯一标识，有独立的生命周期。一 个聚合只有一个聚合根，聚合根在聚合内对实体和值对象采用直接对象引用的方式进行组织 和协调，聚合根与聚合根之间通过 ID 关联的方式实现聚合之间的协同。

- 实体的特点：有 ID 标识，通过 ID 判断相等性，ID 在聚合内唯一即可。状态可变，它依附 于聚合根，其生命周期由聚合根管理。实体一般会持久化，但与数据库持久化对象不一定是 一对一的关系。实体可以引用聚合内的聚合根、实体和值对象。

- 值对象的特点：无 ID，不可变，无生命周期，用完即扔。值对象之间通过属性值判断相等 性。它的核心本质是值，是一组概念完整的属性组成的集合，用于描述实体的状态和特征。 值对象尽量只引用值对象。

- 贫血模型：指使用的领域对象中只有setter和getter方法，所有的业务逻辑都不包含在领域对象中而是放在业务逻辑层。

- 充血模型将大多数业务逻辑放在领域实体中实现，实体本身包含了属性和它的业务行为，它在领域模型中就是一个具有业务行为和逻辑的基本业务单元。

### 领域事件

- 领域事件：这种事件发生后通常会导致进一步的业务操作，在DDD中这种事件被称为领域事件。强调最终一致性。

领域事件驱动设计可以切断领域模型之间的强依赖关系，事件发布完成后，发布方不必关心 后续订阅方事件处理是否成功，这样可以实现领域模型的解耦，维护领域模型的独立性和数 据的一致性。在领域模型映射到微服务系统架构时，领域事件可以解耦微服务，微服务之间 的数据不必要求强一致性，而是基于事件的最终一致性。

微服务内的领域事件：一对一的，使用观察者模式；一对多的，一个事件如果同时更新多个聚合，按照DDD“一次事务只 更新一个聚合”的原则，考虑是否引入事件总线。

微服务间的领域事件：要总体考虑事件构建、发布和订阅、事件数据持久化、消息中间件，甚至事件数据持久化时还可能需要考虑引入分布式事务机制等。

**注意：**分布式事务机制 会影响系统性能，增加微服务之间的耦合，所以我们还是要尽量避免使用分布式事务。

- 领域事件总体架构：事件构建和发布、事件数据持久化、事件总线、消息中间件、事件 接收和处理等。

**问题：**如果采用了主流的消息队列（如rabbitmq，kafka，rocketmq），是否领域事件还需要持久化？

*回复：*虽然这些消息队列自身有持久化的功能，但是中间过程，或者在订阅到数 据后，在处理之前出问题，需要进行数据对账，这样就没法找到发布时和处理后的数据版本。关键的业务数据我建议还是落库比较好。

### DDD分层架构

基础层、用户接口层、应用层、领域层

![补充图片](分层架构结构.png)

DDD 分层架构有一个重要的原则：每层只能与位于其下方的层发生耦合。

微服务架构演进：

领域模型中对象的层次从内到外依次是：值对象、实体、聚 合和限界上下文。

微服务内服务的演进：


三层架构向DDD分层架构演进：

![补充图片](三层架构向DDD分层架构演进.png)

DDD 分层架构、整洁架构、六边形架构都是以领域模型 为核心，实行分层架构，内部核心业务逻辑与外部应用、资源隔离并解耦。

### 中台和DDD的关系

当你去做领域划分的时候，请务必结合企业战略，这恰恰也体现了 DDD 领域建模的重要性。

中台：企业级的能力复用

### DDD实践

- 如何构建中台业务模型？

1. 自顶向下：适用于全新的应用系统建设，或旧系统推倒重建的情况。

2. 自底向上：适用于遗留系统业务模型的演进式重构

步骤：锁定系统所在业务域，构建领域模型；对齐业务域，构建中台业务模型；中台归类，根据领域模型设计微服务。

中台业务建模时，既要关注领域模型的完备性，也要关注不同渠道敏捷响应市场的要求。

构建多业务域的中台业务模型的过程，就是找出同一业务域内所有同类业务的领域模型，对 比分析域内领域模型和聚合的差异和共同点，打破原有的模型，完成新的中台业务模型重组或归并的过程。

核心要点：分域建模型，找准基准域，划定上下文，聚合重归类。

划分完成后，针对领域对象的调整：部分领域对象可能会根据新的业务要求，从原来的聚合中分离，重组到其它 聚合。新领域模型的领域对象，比如实体、领域服务等，在重组后可能还会根据新的业务场景和需求进行代码重构。

业务边界即微服务边界！

- 如何用事件风暴构建领域模型？

采用 DDD 方法建立的领域模型，可以清晰地划分微服务的逻辑边界和物理边界。

事件风暴正是 DDD 战略设计中经常使用的一种方法，它可以快速分析和分解复杂的业务领域，完成领域建模。

1. 准备部分：参与者、材料、场地、关注点

2. 具体实施：

    - 产品愿景

    参与角色：领域专家、业务需求方、产品经理、项目经理和开发经理。用户中台到底能够做什么？ 它的业务范围、目标用户、核心价值和愿景，与其它同类产品的差异和优势在哪里？
    思考点：用户中台到底能够做什么？业务范围、目标用户、核心价值和愿景，与其它同类产品的差异和优势在哪里？

    - 业务场景分析

    参与角色：领域专家、产品经理、需求分析人员、架构师、项目经理、开发经理 和测试经理。
    从用户视角出发的，根据业务流程或用户旅程，采用用例和场景分析，探索领域 中的典型场景，找出领域事件、实体和命令等领域对象，支撑领域建模。事件风暴参与者要 尽可能地遍历所有业务细节，充分发表意见，不要遗漏业务要点。
    场景分析时会产生很多的命令和领域事件。

    - 领域建模
    参与角色：领域专家、产品经理、需求分析人员、架构师、项目经理、开发经理 和测试经理。
    从命令和事件中提取产生这些行为的实体；根据聚合根的管理性质从实体中找出聚合根；划定限界上下文，根据上下文语义将聚合归类

    - 微服务拆分与设计
    参与的角色：领域专家、产品经理、需求分析人员、架构师、项目经理、开发经理和测试经理
    在微服务拆分与设计时，我们不能简单地将领域模型作为拆分微服务的唯一标准，它只能作为微服务拆分的一个重要依据。

- 代码模型

![](补充：微服务代码组织图.png)

微服务落地时首先要确定的就是微服务的代码结构

注意：聚合之间的代码边界一定要清晰；一定要有代码分层的概念。

DDD 强调先构建领域模型然后设计微服务，以保证领域模型和微服务的一体性，因此我们不能脱离领域模型来谈微服务的设计和落地。但在构建领域模型时，我们往往是站在业务视角的，并且有些领域对象还带着业务语言。我们还需要将领域模型作为微服务设计的输入，对领域对象进行设计和转换，让领域对象与代码对象建立映射关系。

领域层的领域对象：设计实体、找出聚合根、设计值对象、设计领域事件、设计领域服务、设计仓储。

应用层的领域对象：实体方法的封装、领域服务的组合和封装、应用服务的组合和编排。应用服务和事件的发布以及订阅。

建立领域对象与微服务代码对象的映射。

- 边界

微服务架构设计中的各种边界在架构演进中的作用。

逻辑边界：微服务内聚合之间的边界是逻辑边界。它是一个虚拟的边界，强调业务的内聚， 可根据需要变成物理边界，也就是说聚合也可以独立为微服务。

物理边界：微服务之间的边界是物理边界。它强调微服务部署和运行的隔离，关注微服务的 服务调用、容错和运行等。

代码边界：不同层或者聚合之间代码目录的边界是代码边界。它强调的是代码之间的隔离， 方便架构演进时代码的重组。

通过以上边界，我们可以让业务能力高内聚、代码松耦合，且清晰的边界，可以快速实现微 服务代码的拆分和组合，轻松实现微服务架构演进。但有一点一定要格外注意，边界清晰的 微服务，不是大单体向小单体的演进。

