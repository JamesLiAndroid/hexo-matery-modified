---
title: k8s方案规划
top: false
cover: false
toc: true
mathjax: true
date: 2020-02-12 17:39:17
password:
summary:
tags:
categories:
---

# k8s方案规划

## 概述

随着我们微服务开发的深入，从微服务的单一jar包部署转到了单一镜像部署模式，初步实现了CI/CD自动化流水线部署模式，能够极大的满足我们目前的开发方式。但是随着微服务数量的增加，运维的难度也在不断升高，bug的排除，请求的监控需要一条较长的链路。顺着链路去排查问题，带来的时间成本显著上升。目前的部署模式是以单一docker镜像或者docker-compose实现简单的服务编排，目前还无法做到自动化的集群化部署，不能很好的做到单个微服务部署多套通过负载均衡控制访问。在微服务的熔断、限流等层面尚未有很好的解决方式，仅凭硬编码解决是不够的，硬编码后还需要将服务推送的服务器上替代和生效，影响目前的系统运行方式，同样的无法做到不停机升级。在服务编排上，我们目前只能通过API Gateway来实现微服务层面的服务编排，功能有限

针对我们目前遇到的这些问题，引入容器编排的功能，对目前容器化部署策略进行管理上的提升。容器编排的框架有很多，例如Docker Swam、Kubernetes、Fleet、Mesos，各有特点，也各有应用场景。根据我们本阶段的规划，考虑到运维平台的搭建和运作，结合目前已有的部署方式，选择Kubernetes进行搭建。

### 背景和历史

在Docker 作为高级容器引擎快速发展的同时，Google也开始将自身在容器技术及集群方面的积累贡献出来。在Google内部，容器技术已经应用了很多年，Borg系统运行管理着成千上万的容器应用，在它的支持下，无论是谷歌搜索、Gmail还是谷歌地图，可以轻而易举地从庞大的数据中心中获取技术资源来支撑服务运行。

Borg是集群的管理器，在它的系统中，运行着众多集群，而每个集群可由成千上万的服务器联接组成，Borg每时每刻都在处理来自众多应用程序所提交的成百上千的Job, 对这些Job进行接收、调度、启动、停止、重启和监控。正如Borg论文中所说，Borg提供了3大好处:

1）隐藏资源管理和错误处理，用户仅需要关注应用的开发。

2) 服务高可用、高可靠。

3) 可将负载运行在由成千上万的机器联合而成的集群中。

作为Google的竞争技术优势，Borg理所当然的被视为商业秘密隐藏起来，但当Tiwtter的工程师精心打造出属于自己的Borg系统（Mesos）时， Google也审时度势地推出了来源于自身技术理论的新的开源工具。

2014年6月，谷歌云计算专家埃里克·布鲁尔（Eric Brewer）在旧金山的发布会为这款新的开源工具揭牌，它的名字Kubernetes在希腊语中意思是船长或领航员，这也恰好与它在容器集群管理中的作用吻合，即作为装载了集装箱（Container）的众多货船的指挥者，负担着全局调度和运行监控的职责。

虽然Google推出Kubernetes的目的之一是推广其周边的计算引擎（Google Compute Engine）和谷歌应用引擎（Google App Engine）。但Kubernetes的出现能让更多的互联网企业可以享受到连接众多计算机成为集群资源池的好处。

Kubernetes对计算资源进行了更高层次的抽象，通过将容器进行细致的组合，将最终的应用服务交给用户。Kubernetes在模型建立之初就考虑了容器跨机连接的要求，支持多种网络解决方案，同时在Service层次构建集群范围的SDN网络。其目的是将服务发现和负载均衡放置到容器可达的范围，这种透明的方式便利了各个服务间的通信，并为微服务架构的实践提供了平台基础。而在Pod层次上，作为Kubernetes可操作的最小对象，其特征更是对微服务架构的原生支持。

Kubernetes项目来源于Borg，可以说是集结了Borg设计思想的精华，并且吸收了Borg系统中的经验和教训。

Kubernetes作为容器集群管理工具，于2015年7月22日迭代到 v 1.0并正式对外公布，这意味着这个开源容器编排系统可以正式在生产环境使用。与此同时，谷歌联合Linux基金会及其他合作伙伴共同成立了CNCF基金会( Cloud Native Computing Foundation)，并将Kuberentes 作为首个编入CNCF管理体系的开源项目，助力容器技术生态的发展进步。Kubernetes项目凝结了Google过去十年间在生产环境的经验和教训，从Borg的多任务Alloc资源块到Kubernetes的多副本Pod，从Borg的Cell集群管理，到Kubernetes设计理念中的联邦集群，在Docker等高级引擎带动容器技术兴起和大众化的同时，为容器集群管理提供独了到见解和新思路。

### 特点

* 可移植: 支持公有云，私有云，混合云，多重云（multi-cloud）
* 可扩展: 模块化, 插件化, 可挂载, 可组合
* 自动化: 自动部署，自动重启，自动复制，自动伸缩/扩展

因为容器小而快，一个应用可以被打包进一个容器映像。正是应用与容器镜像间一对一的关系解锁了容器的很多优点：

* 在build或者release 的阶段（而非部署阶段）可以创建不变的容器镜像，因为每个应用都用和其他的应用栈相组合，也不依赖于生产环境基础设施。这使得从研发到生产过程中可以采用持续的环境。
* 容器比虚机要更加透明，这更便于监控和管理。尤其是因为窗口的进程的生命周期是被基础设施直接管理而不是被容器中的进程管理器隐藏起来管理。
* 因为一个容器包含一个应用，这让对容器的管理等同于对应用部署的管理。


Kubernetes一个核心的特点就是自动化，能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着（比如用户想让apache一直运行，用户不需要关心怎么去做，Kubernetes会自动去监控，然后去重启，新建，总之，让apache一直提供服务），管理员可以加载一个微型服务，让规划器来找到合适的位置，同时，Kubernetes也系统提升工具以及人性化方面，让用户能够方便的部署自己的应用（就像canary deployments）。

现在Kubernetes着重于不间断的服务状态（比如web服务器或者缓存服务器）和原生云平台应用（Nosql）,在不久的将来会支持各种生产云平台中的各种服务，例如，分批，工作流，以及传统数据库。

### 建设层面--PaaS层

1. PaaS是面向应用的核心平台。

2. 从功能定义和核心价值分为三个层次：

   1）自动化获取资源进行部署；

   2）提供标准化的编程框架和服务来帮助应用开发和运行实现自动化；

   3）无需感知底层资源的应用自动化运维（包括配置、升级、伸缩等等）。

结合我们目前的情况，我们需要兼容不同的云平台体系——公有云、私有云、混合云，需要面向针对微服务的调度优化，需要自动化的运维功能，需要逐步加入服务网格的功能特性，需要应对大规模服务部署方式，需要扩展AIOps的功能特性。通过对PaaS层进行建设，为微服务的编排提供基础，保障运维效率，保障服务运行，能够支持各类部署方式——灰度部署、蓝绿部署、滚动部署。

## 为什么使用kubernetes

### 痛点

* 单一服务单一镜像，未添加到服务集群，无法进行弹性伸缩、A/B测试、流量切换操作
* 自动化程度不足，需要人工干预的点太多
* 微服务的熔断、限流、降级完成不足，尚需要编码部署之后进行生效
* 部署方式限制，灰度部署、蓝绿部署、滚动部署尚未建设，部署难度过大
* 微服务过多，管理不直观，操作复杂
* 监控体系不足，日志采集、运行参数采集、异常告警尚不到位，仅仅建设了全链路监控体系

### 优势

Kubernetes可以满足很多运行环境中应用的通用的需求，比如：

* 进程协同，利用复合应用保证应用和容器一对一的模型。
* 存储系统挂载
* 分发密钥
* 应用健康检测
* 应用实例复制
* 水平自动扩展
* 命名和发现
* 负载均衡
* 滚动更新
* 资源监控
* 日志访问
* 自检和调试
* 识别和认证

这为PaaS提供了IaaS层的便利，提供了基础设施提供者间的可移植性。

但是Kubernetes不是一个传统的，包罗一切的PaaS系统。我们保留用户的选择，这一点非常重要。

* Kubernetes不限制支持应用的种类。它不限制应用框架，或者支持的运行时语言，也不去区分 “apps” 或者“services”。 Kubernetes致力于支持不同负载应用，包括有状态、无状态、数据处理类型的应用。只要这个应用可以在容器里运行，那么它就可以在Kubernetes上很多地运行。

* Kubernetes不提供中间键（如message buses），数据处理框架（如Spark），数据库(如Mysql)，或者集群存储系统(如Ceph)。但这些应用都可以运行于Kubernetes。

* Kubernetes没有一个点击即可用的应用市场。

* Kubernetes不部署源码不编译应用。持续集成的 (CI)工作流方面，不同的用户有不同的需求和偏好，因此，我们提供分层的 CI工作流，但并不定义它应该怎么做。

* Kubernetes允许用户选择自己的日志、监控和报警系统。

* Kubernetes不提供可理解的应用配置语言(e.g., jsonnet)。

* Kubernetes不提供或者任何综合的机器配置，维护，管理或者自愈系统。

另一方面，大量的Paas系统都可以运行在Kubernetes上，比如Openshift, Deis, 和Gondor。你可以构建自己的Paas平台，集成CI。因为Kubernetes运行在应用而非硬件层面，它提供了普通的Paas平台提供的一些通用功能，比如部署，扩展，负载均衡，日志，监控等。然而，Kubernetes并非一个庞然大物，这些功能老师可选的。另外，Kubernetes不仅仅是一个“编排系统”；它消弥了编排的需要。“编排”的定义是指执行一个预定的工作流：先做A，之后B，然后C。相反地，Kubernetes是由一系列独立的、可组合的驱使当前状态走向预想状态的控制进程组成的。怎么样从A到C并不重要：达到目的就好。当然也是需要中心控制的；方法更像排舞的过程。这让这个系统更加好用更加强大、健壮、 有弹性且可扩展。

Kubernetes 是云原生（Cloud Native Computing）哲学的体现，通过容器技术和抽象的 IaaS 接口，屏蔽了底层基础设施的细节和差异，可实现多环境部署并可以在多环境之间灵活迁移；这样一方面可以实现跨域、多环境的高可用多活灾备，另一方面帮助用户不必被某个云厂商、底层环境所绑定。

### 风险

使用k8s最大的风险是，学习成本。当前学习成本过高，概念多，不容易理解，短期内掌握不太现实。

其次问题在于，服务器资源问题，测试环境可以简单进行搭建，目前无法预知大规模部署时，对容量的规划方案。

最后，kubernetes不是银弹，虽然天然契合微服务，但是目前无法预知部署时的问题。

另外，目前尚不知道是否需要针对微服务开发的过程进行变更，例如针对Dockerfile的重写、各类请求地址的变更，有不小的变动。

针对私有化部署，如何准备部署环境，也是一个不小的考验。

### 规避风险

* 针对学习成本问题，建议拆分学习，优先使用起来，直接进入实战，引入外部资源进行指导培训。
* 针对服务器资源的问题，需要进行协调。
* 针对部署时问题，优先考虑一键部署和简化部署的方式，在不影响主体功能的情况下进行部署。
* 针对微服务的开发过程变更，需要同组内成员统一讨论、协商、培训。

## 实现什么

### 功能特性

* 微服务集群化
* 资源调度。自动扩容、应用实例复制、水平自动扩展。
* 资源隔离。进程隔离，资源划分（开发、运维、测试），权限控制。
* 流量控制。流量转移和服务优雅停机。
* 数据监控。日志监控、运行数据监控，异常告警。
* 易迁移，易扩展。
* 服务自动发现和注册。
* 部署更新。滚动部署、蓝绿部署、A/B测试。
* 负载均衡。
* 对接CI/CD，实现自动化部署。

其它由k8s实现的功能特性需要继续补充。

## 如何做

### 基础

直接部署k8s环境，以主从模式进行部署。划定一个三主六从的环境，三主使用keepalived+HAProxy保证高可用。

实施前提如下：

* 服务器的基础镜像，基础工具包，至少要包含docker以及docker-compose，以及k8s相关组件。
* Docker的基础镜像，分为前端和后端的工具镜像。
* 测试微服务程序。

### 各类方案

在k8s的基础上，衍生出各类方案，这里以开源方案为主进行选择，主要包含两类：

* k8s“简化”：这里简化的意思指可以针对k8s部署时的简单化处理，一键脚本部署。主要包括以下方案：

    * [Kuboard](https://kuboard.cn)，一款图形化管理界面。
    * [Tilt](https://tilt.dev/)，主要是为微服务开发提供无压力体验。使用 Tilt 开发微服务允许开发人员在自己的 IDE 中编辑并保存到文件系统，开发人员可在为团队完美配置的环境中处理微服务。定位于本地简化部署环境。
    * [lab-k8s-playground](https://github.com/morningspace/lab-k8s-playground)，简化的k8s安装方式。
    * [sealyun](https://sealyun.com/)，专注于kubernetes安装的简化安装工具。

* k8s扩展：以k8s为基础，扩展出各类实用功能，以商用大厂的开源方案为主。主要包括以下方案：

    * [OpenShift](https://www.openshift.com/)，RedHat出品基于k8s的工具信息。偏向开发侧。
    * [Rancher](https://www.rancher.com/)，偏向运维侧的k8s工具，全开源，服务收费，应用较为广泛。
    * [KubeSphere](https://kubesphere.com.cn/zh-CN/)，以应用为中心的容器平台。


* 开发平台：结合Spring Cloud进行开发的平台，以开发为主。主要包括以下方案

    * [wayne](https://github.com/Qihoo360/wayne)，360开源的开发工具。
    * [rainbond](https://www.rainbond.com/)
    * [Choerodon猪齿鱼](http://choerodon.io/zh/)
    * [bk-bcs-saas](https://github.com/Tencent/bk-bcs-saas)

目前以k8s简化和扩展中进行选择，对于开发平台，我们并不选择进行集成，深度集成会破坏我们目前的开发方式以及现有微服务的迁移。

### 方案对比

如果以简化安装的角度来看，在lab-k8s-playground和sealyun选择一个进行安装k8s即可。

如果以扩展平台的思路来看，基于已安装的k8s进行使用，三者均可以选择，不过KubeSphere开源版本功能缺失较多。

### 权衡和选择

优先安装完成k8s部署，然后选择OpenShift或者Rancher进行使用。

基于以上选择进行二次开发扩展，添加自己的功能。顺便结合后续运维平台的内容，进行确定扩展的功能。

## 总结

## 参考文档

1. http://www.sohu.com/a/199018805_671228

2. https://segmentfault.com/a/1190000014405563

3. https://www.zhihu.com/question/279119001/answer/465434344

4. 厂商产品选择：https://github.com/leizhnxp/learning/wiki/k8s-PaaS-compare-with-Rancher

5. rancher优劣：https://blog.csdn.net/hxpjava1/article/details/79325516
