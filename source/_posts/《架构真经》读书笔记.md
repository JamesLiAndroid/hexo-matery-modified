---
title: 《架构真经》读书笔记
top: false
cover: false
toc: true
mathjax: true
date: 2019-06-02 10:50:35
password:
summary:
tags: 读书心得
categories: READ
---

# 《架构真经》读书心得

## 50条可扩展性规则

### 前提

1. 拒绝教条，灵活运用
2. 结合实际，适用于当前环境，并且可稍稍向前走一点
3. 有所为有所不为，把握实施的关键节点
4. 批判继承，结合当前国内的互联网环境，结合公司目前所处位置以及所能调动的资源
5. 符合自己当前的需求，符合当前公司、项目的需求

### 大道至简

#### 避免过度设计

警惕复杂的解决方案

#### 2. DID方法

* D - Design 设计20倍容量
* I - Implement 实施3倍容量
* D - Deploy 部署1.5倍容量

要注意的是，避免过度设计！我认为在这个位置，如果一个公司是初期技术形态，亟待创立自己的技术体系，可以先按照**3-2-1**模式走。如果是相对成熟的公司，可以按照DID方法考虑实施。

#### 3. 三次简化方案

- 项目范围： 帕累托原则（2-8原则）简化范围
- 设计：考虑成本优化和可扩展性来简化设计
- 实施：依靠其他人经验来简化部署

80%的收益来自20%的工作，确定核心业务所在边界，是非常重要的。例如，在之前的某养车项目中，其核心业务应该是车辆保养，那么应该强化车辆保养业务在项目中的地位，削弱或者降低洗车、维修、保险这样的非核心业务的优先级。并且根据保养业务需求，简化保养流程设计，并快速实施！

#### 4. 减少域名解析

尽量将所有对象加载放在同一个域名内。这点要批判性的看，第一就是CDN的作用，第二个就是如果这样操作是否会造成负载过大的情况。需要集体评审决定。

#### 5. 减少页面目标

- 减少或合并对象，但要平衡最大并发连接数。
- 寻找机会减轻对象的重量
- 不断测试确保性能提升

无法一蹴而就的行动，需要反复测试，在易用性、可用性、性能之间做平衡。

#### 6. 采用同构网络

这点的化，基本上在国内云主机厂商中，用一家不混用一般是可以的。

### 分而治之--AKF扩展立方体+三轴扩展

![](AKF立方体.png)

![](三轴扩展.png)

#### 7. X轴扩展

其核心是**水平复制**，例如数据库架构中的一写多读，以复制数据和功能为代价获得事务的快速扩展。

#### 8. Y轴拆分

其核心是**服务或者资源的拆分**，沿动词（服务）拆分，沿名词（资源或者数据）拆分，或者是沿着动词/名词的边界拆分服务和数据。

#### 9. Z轴拆分

其核心是**分片、分组、分块**，例如基于用户群属性，将数据库拆分为学生、工人、白领、农民四个层次，在此基础上，将服务进行这四个维度的拆分，调整数据库大小和读写策略。
总结就是通过克隆扩展（X轴），通过拆分不同的东西扩展（Y轴），通过拆分类似的东西来扩展（Z轴）。

### 水平扩展

#### 10. 向外扩展

横向拆分数据库和事务。对应于*向上扩展*，购买更强的硬件配置实现。我认为，向上扩展可以结合当前云服务商的弹性伸缩功能去用，不要一棒子打死！

#### 11. 商品化系统

阿里的去IOE行为，抛弃大型、特定的硬件，转而使用小型廉价灵活的系统，这样适合于快速调整，也有利于人员成本降低。

#### 12. 托管方案扩展

核心是三数据中心配置：

![](三数据中心配置.png)

![](多数据中心成本比较1.png)

![](多数据中心成本比较2.png)

结合我们的AKF立方体进行拆分，在不同数据中心做不同的配置。对比冷-热双活数据库配置，这样是极好的。

#### 13. 利用云

可以将三数据中心的一个数据中心，上云。利用云服务的弹性伸缩功能，灵活扩展，应对突发需求。但是上云也要注意数据安全！

### 工欲善其事，必先利其器

马斯洛的锤子理论：如果你手里拿着一把锤子，看什么就都会像钉子。不要妄图“一招鲜，吃遍天”。

#### 14. 适当使用数据库

关系型和非关系型数据库结合使用。NoSQL划分为Key-Value和File两种，强调利用各自优势！

![](数据库方案决策模型.png)

#### 15. 慎重使用防火墙

只对核心业务以及安全性要求高的业务使用，例如：支付流程、用户信息等。

#### 16. 积极使用日志文件

通过日志信息诊断和预防问题，也可以进行事故现场复原分析。利用InfluxDB+Grafana进行监控也是极好的。
但是日志是有代价的，比如：运行状态变慢、过多日志带来的额外数据成本等。

- 总结
引入每项新技术，都需要另外一种技能来支持。尽管工作中使用合适的工具很重要，但是不要过度强调专业化，以至于没有足够深度的技能来支持。先用，有了问题再去解决和攻关，用的时候胆大心细即可。

### 画龙点睛

#### 17. 避免画蛇添足

永远不要为确认操作是否有效而读取刚刚写入的数据。同样的，扩展一下，减少在创建数据的时候重复去查询已有的数据。

#### 18. 停止重定向

#### 19. 放宽时间约束--针对数据库事务

CAP原则：

Consistency- 一致性
Availability- 可用性
Partition tolerance- 分区容错性

解决方案-BASE：

Basically Available - 基本可用
Soft state - 软状态
Eventually consistent - 最终一致性

### 缓存为王

#### 20. 利用CDN缓存

针对静态资源获取，减少动态生成js文件，减轻服务器压力。要结合前后端分离做！
向上添加边缘加速服务，提升访问速度。

#### 21. 灵活管理缓存

使用Expires头和Cache-Control头来减少请求量。

#### 22. 利用Ajax缓存

适当调整实时性要求不高的请求接口进行缓存，适当调整Last-Modified、Cache-Control、Expires头。核心目标是减少在网络上来回传输数据，减少用户感知的响应时间和降低服务器负载！

#### 23. 利用页面缓存

例如Nginx中针对静态文件的缓存。要实施页面缓存，使用适当的http头，尽可能包括RFC2616中另外的HTTP头。

#### 24. 利用应用缓存

确定可能使用的情况，根据AFK立方体进行拆分。

#### 25. 利用对象缓存

Redis、Memcached，确定使用哪种类型的对象缓存，在数据库和应用层之间实施。最后需要监控缓存命中率，及时调整负载。

#### 26. 独立对象缓存

缓存层的建设和划分，单独作为一层进行建设。

### 前车之鉴

#### 27. 失败乃成功之母

抓住每个机会，尤其是失败的机会，学习经验并吸取教训。犯错不可怕，从错误中学习和进步才是重要的。创建学习型团队，应对业务的不断增长！例如，针对华为项目的特殊要求，我们对当前单体应用支持逐步扩展，满足其业务需求，也对于我们自身下一步的成长打下基础！

- 关注失败
- 拒绝简化解释
- 对操作的敏感性
- 坚守弹性承诺
- 尊重专业经验

#### 28. 不靠QA发现错误

交付QA时，尽量保证自己的代码测试到位！通过QA去认识问题缺陷，更好的学习！

#### 29. 不能回滚注定失败

代码的版本控制。
数据库文件的版本控制，针对数据修改时：

- 数据库结构的变更仅可以增加
- 数据库变更脚本化并经过测试
- 限制应用中SQL的查询的使用，尤其是：**select \***这样的调用
- 数据的语义变化
- 上线、下线可控

产出过程可控，产物可控！例如，一个比较极端的例子，在之前的养车项目中，后端源代码丢失，导致修改时只能进行jar包反编译，添加代码后再编译打包放入服务器，由此带来的生产事故是：某次打包放入服务器的jar包有错误，修改之前未备份，导致整个服务不能工作。

### 重中之重

#### 30. 从事务中清除商务智能

减少数据库里面所使用的存储过程和商业逻辑，对不同系统进行拆分和隔离。专注于重要系统的工作，拆分出占比不高或者优先级较低的业务！

#### 31. 注意昂贵的关系

设计数据库模型时，考虑数据库分离和未来可能的数据需求，谨慎的考虑数据库变更带来的成本问题。这一点可能需要提前设计！数据库三范式以及表查询连接。

#### 32. 正确使用数据库锁

选择锁类型以及如何使用，重中之重！确保最佳的解决方案！

#### 33. 禁用分阶段提交

两阶段和三阶段提交，锁定应用服务器太久的问题，引发超时或者无响应的反馈！

#### 34. 慎用Select for Update

For update语句导致游标长期占用锁的问题，减缓事务完成时间。

结合我们之前华为项目中大BOM列表加载时间问题，可以由此排查下？

#### 35. 避免选择所有列

不要在查询中使用Select *。

### 有备无患

#### 36. 用泳道隔离故障

禁止故障隔离的服务和数据间同步通信或访问。

原则：

- 泳道之间什么都不共享
- 泳道之间不进行同步调用
- 限制泳道之间的同步调用
- 绝对必要时，如何实现跨越泳道边界的异步传输

![](故障隔离优势.PNG)

![](故障隔离原则.PNG)

#### 37. 拒绝单点故障

消除系统内的单点故障，努力实施主动/主动模式，负载均衡。单例情形下，可在主动/被动模式的实例中采用控制服务。

#### 38. 避免系统串联

层级之间串联，层级内并联多个相同组件，可选择性。通过减少串联组件或者增加并联组件来降低风险。

#### 39. 启用与禁用功能

可随时控制服务的上线下线。

### 超然物外

#### 40. 力求无状态

无状态系统构建，减少相互之间依赖！简单和容易更加重要！

#### 41. 在浏览器保存会话数据

如果一定是有状态的系统，尽量使用cookie来保存数据。使用SSL协议进行通信加解密，然后建议使用至少两个cookie的模式，一个是授权cookie，针对ajax请求；另一个，是普通cookie，请求不重要的数据时，通过不安全的HTTP传输。

#### 42. 用分布式缓存处理状态

![](分布式缓存禁忌.png)

![](分布式缓存考虑.png)

改造趋势从42，41，40的路线去走，切记不要一蹴而就！

### 异步通信

#### 43. 尽可能异步通信

#### 44. 扩展消息总线

![](消息总线AKF立方体.png)

![](消息总线AKF立方体2.png)

#### 45. 避免消息总线过度拥挤

不要发布一切消息到消息总线中，要判断消息价值几何！

选择消息队列框架，需要根据需求和使用场景筛选。

### 意犹未尽


#### 46. 警惕第三方方案

第三方服务慎重选择！不要过度依赖供应商的产品，要进行多地灾备！

#### 47. 梯形存储策略

将存储成本和数据价值匹配，应用RFM营销概念，即近因、频率、货币化分析！


![](RFM的AKF立方体.png)

![](RFM的价值成本解决方案.png)

#### 48 分类处理不同负载

归纳、演绎、批处理、用户产品交互(OLTP)

#### 49. 完善监控

设计监控系统，结合日志进行考虑。

![](监控范围三角形.png)

#### 50. 保持竞争力

架构的每个部分都有竞争力，而且对于团队而言，补齐短板，均衡发展！

### 谋定而动

![](可扩展性风险分析.png)

## 最终思考路线图

整体套用AKF三角形！

业务拆分->数据库优化->故障隔离->异地多活->缓存应用->存储系统->负载均衡->消息队列->前端优化->监控系统

## 总结

![](《架构真经》最终脑图.png)