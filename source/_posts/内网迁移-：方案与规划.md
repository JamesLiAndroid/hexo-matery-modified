---
title: 内网迁移-：方案与规划
top: false
cover: false
toc: true
mathjax: true
date: 2020-08-21 10:12:53
password:
summary:
tags:
categories:
---

## 操作的范围

* 内外网互通的部分

    1. yum安装源
    2. maven仓库，需要从外网拉取的部分
    3. docker镜像仓库，需要从外网拉取的部分
    4. npm镜像仓库，需要从外网拉取的部分
    5. jenkins插件仓库、sonarqube插件仓库
    6. 各类工具的联网激活

解释：

1. yum安装源：服务器的更新升级、必要工具如curl等日常运维工具的安装

2. maven仓库：本地jar包发布，从外网拉取依赖的jar包保存在本地

3. docker镜像仓库：构建产物发布，从外网拉取必要的镜像信息，提供k8s构建工具链

4. npm镜像仓库：本地组件包发布，从外网拉取的组件信息

5. jenkins插件仓库

* 需要迁移到内网的部分

    0. 机器部分
    各个服务器的迁移，需要区分迁移的范围

    1. 基础设施
    gitlab、sonarqube、jenkins、docker registry、nexus

    2. 服务部分
    k8s、k8s外部服务、已运行的服务信息

* 跳板机部分、VPN

新增一台高性能服务器做跳板机，需要创建新的可靠的VPN接入。

* 需要注意的是

    1. 尽量不变更现有虚拟机的ip地址信息，允许将ip段地址迁移到内网
    2. 配置存储工具信息，尽量将存储挂载到服务器上以提升性能

## 过程

0. 操作系统安装，初始化，系统更新，k8s安装
1. 统一maven仓库为例，验证内网拉取新的依赖信息是否成功
2. 统一各个docker仓库，统一从该仓库拉取所有镜像，并且对仓库拉取外部的docker镜像进行缓存并进行安全检查
3. 统一npm镜像仓库，迁移到内网中
4. 备份当前机器。备份完成后开始迁移工作，要求ip不做变更
5. 基础设施迁移，gitlab、jenkins、sonarqube、docker registry（或者Harbor）、nexus，不再使用docker镜像，全部更换为安装版运行
6. 全面迁移运行环境，全面迁移开发机进入内网
7. 内网与外部云服务的连通

## 前提

1. 梳理服务器涉及的所有外网地址，域名ip信息
2. 梳理服务器需要进行的配置变更部分，例如docker的daemon.json、hosts文件
3. 梳理基础服务部分需要进行的配置变更，例如jenkins拉取地址的变化
4. 梳理各个服务需要进行的配置变更
5. 当前环境的备份

## 潜在问题

1. 部分工具的激活，例如开发工具idea的激活，这部分工具在哪个位置存储
2. 入站审计，例如某些破解软件是否可以放到内网环境使用，工具链使用范围
3. docker镜像的安全审计，代理的docker镜像源中拉取的镜像审计
4. 个人外网无法连接问题，是否配置个人电脑连接外网，陈君、庞德镇需要配置台式机接入内网环境
5. 迁移时，所有人工作停滞的问题，如何协调
6. 如何安装新的工具到内网运行环境中
7. 开发教学资源如何配置，API手册、javadoc、日常开发的需要搜索引擎资源查询时，如何解决
8. 内网安全规则如何培训？原则是什么？
9. 尚有其他部门的代码目前在我们的代码库中管理，对于他们的如何进行处理？
10. 是否有代码审计工具保证内网运行稳定？例如使用FCA 

## 验证阶段

* 1. 内外网交互验证

以yum包管理工具和maven、npm依赖管理工具，验证内外网互通问题，以正常拉取安装工具为准

* 2. 基本开发验证

以简单的前端和后端代码为例子，在内网环境配置并执行构建，部署到测试服务器上，以接口调用互通为准

* 3. 基础设施流水线运行验证

将CI/CD流水线接入，验证自动化构建工具运行，排查对外访问的URL不受影响；开发机接入，CI/CD流水线运行验证，自动化构建推送到运行环境中，以所有服务连通为准

* 4. kubernetes集群环境验证

验证k8s集群安装的工作，验证集群运行，镜像拉取

* 5. 真实开发案例验证

验证目前的某只业务功能，在内网的开发流程，以及能否顺利上线完成功能需求

## 验证过程

0. 资源需求（需要外部协助）

一台域名服务器、一台带有双网卡的跳板机、两台内网运行环境验证机器（可以是虚拟机）、一台内网开发机、三台内网k8s运行环境验证机器（可以是虚拟机，第四阶段需要）

其中运行环境验证机器配置要求：4核心8G内存100GB硬盘千兆网卡，该配置适用于所有运行环境验证机器。开发机配置：4核心8G内存100GB硬盘百兆网卡。

域名服务器和跳板机目前无法给出配置，需要外部协助配置。

1. 第一阶段（需要9.5天）

    - 准备所需资源 ---- 2天

    - 安装操作系统（需要外部协助），域名服务器配置，跳板机配置（需要外部协助） ---- 3天

    - Centos7配置yum源，初始化配置内网运行环境 ---- 1天

    - 复制maven源到运行环境，复制npm源到内网运行环境，nexus安装  ---- 2天

    - 在跳板机配置外网转发规则（需要外部协助）--- 0.5天
    
    - 测试yum安装常用工具、maven/npm拉取常用依赖包信息（需要外部协助）  ---- 1天

2. 第二阶段（需要2.5天）

    - 编写单个后端项目，本地运行   ---- 0.5天

    - 编写本地项目，生成jar包，构建打包推送到内网运行环境，测试服务是否能通过开发机访问  --- 0.5天

    - 编写前端项目，打包生成运行文件，部署到内网运行环境 ---- 1天

    - 前后端联调，通过即为验证完成   ---- 0.5天

3. 第三阶段（需要4天）

    - 基础设施进入内网环境进行部署，迁移数据到内网环境，部署完成后验证是否可用（3天）

        * gitlab：能够拉取和提交代码
        * jenkins：能够触发构建，能够从gitlab中拉取代码，能够将构建产物推送到docker镜像仓库
        * docker镜像仓库：能够从中推送和拉取镜像
        * nexus: 能够拉取依赖包，能够推送生成的jar包

    - 基础设施联调，CI/CD流水线构建全部走通（1天）

4. 第四阶段（需要6天）

    - 添加三台内网k8s运行的验证机器（2天）
    - k8s原生安装验证，不再使用rancher（4天）

5. 第五阶段（需要2天）

    - 拿一支真实的开发案例来实验，从内网走通整个开发流程（2天）

## 输出内容

* 验证问题文档，记录验证过程中出现的内容

* 安装包列表，需要准备的工具合集